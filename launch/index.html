<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Projectile</title>

    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <style>

        circle {
            fill: #2c8f9c;
            fill-opacity: 1;
        }

        line {
            stroke: #000;
            stroke-width: 2px;
        }

        text {
            font-family: 'Open Sans', sans-serif;
            font-size: 18px;
            font-weight: bold;
            fill: #000;
        }

        .split {
            stroke: #808080;
        }

        .splitLine {
            stroke-dasharray: 5, 5;
        }

        .active {
            stroke: #000;
            stroke-width: 2px;
        }

    </style>

</head>
<body>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script>

    const width = 700;
    const height = 500;
    const ballDim = {'x': 50, 'y': 100, 'r': 20};
    const velBall = {'r': 15};
    const vectorCoords = {'x': 50, 'y': 50};
    const arrowOffset = 8;
    const colour = d3.scaleOrdinal(d3.schemeCategory10);

    var animate = false;
    var start = Date.now();
    var mem = 0;
    var launchCount = 0;
    var markerCount = 0;

    var svg = d3.select('body').append('svg')
        .attr('width', width)
        .attr('height', height)
        .attr('overflow', 'hidden')
        .style('border', '1px solid black');

    initArrows();
    initBall();
    initButtons();

    d3.timer(animateBall);


    // Initialise everything
    function initBall() {

        svg.append('g')
            .attr('id', 'flightPath');

        svg.append('circle')
            .attr('cx', ballDim.x)
            .attr('cy', height - ballDim.y)
            .attr('r', ballDim.r)
            .attr('id', 'shadowBall')
            .style('fill-opacity', 0.3);

        svg.append('circle')
            .attr('r', ballDim.r)
            .attr('id', 'ball')
            .call(d3.drag()
                .on("start", dragStart)
                .on("drag", dragActiveBall)
                .on("end", dragEnd));

        resetBall();
    }

    function initArrows() {

        initHeightArrow();
        initTriangle();

        function initHeightArrow() {
            svg.append('g')
                .attr('transform', 'translate(' + ballDim.x + ',' + height + ')')
                .attr('id', 'heightArrowContainer');

            d3.select('#heightArrowContainer').append('line')
                .attr('id', 'heightLineBody');

            initArrowHeads();

            updateHeightArrow();

            function initArrowHeads() {
                d3.select('#heightArrowContainer').append('g')
                    .attr('id', 'heightArrowHeadContainer');

                d3.select('#heightArrowHeadContainer').selectAll('line')
                    .data(d3.range(2))
                    .enter().append('line')
                    .attr('x2', function(d) {return (d ? -1 : 1) * arrowOffset; })
                    .attr('y2', -arrowOffset);

                d3.select('#heightArrowContainer').append('g')
                    .attr('id', 'heightTopArrowHeadContainer');

                d3.select('#heightTopArrowHeadContainer').selectAll('line')
                    .data(d3.range(2))
                    .enter().append('line')
                    .attr('x2', function(d) {return (d ? -1 : 1) * arrowOffset; })
                    .attr('y2', arrowOffset);
            }
        }

        function initTriangle() {

            initTriangleContainers();
            initArrowHead();
            initLineBody();
            initBall();

            updateTriangle();

            function initTriangleContainers() {
                svg.append('g')
                    .attr('transform', 'translate(' + ballDim.x + ',' + (height-ballDim.y) + ')')
                    .attr('id', 'triangle');
                d3.select('#triangle').append('g')
                    .attr('id', 'triangleRight');
                d3.select('#triangleRight').append('g')
                    .attr('id', 'triangleTop');
                d3.select('#triangle').append('g')
                    .attr('id', 'velocity');
                d3.select('#velocity').append('g')
                    .attr('id', 'velocityArrowHead');
            }

            function initArrowHead() {
                // horizontal line arrowHead
                d3.select('#triangleRight').selectAll('line')
                    .data(d3.range(2))
                    .enter().append('line')
                    .attr('x2', -arrowOffset)
                    .attr('y2', function(d) {return (d ? -1 : 1)*arrowOffset; })
                    .classed('split', true);

                // vertical line arrowhead
                d3.select('#triangleTop').selectAll('line')
                    .data(d3.range(2))
                    .enter().append('line')
                    .attr('x2', function(d) {return (d ? -1 : 1)*arrowOffset; })
                    .attr('y2', arrowOffset)
                    .classed('split', true);

                // vector arrowHead
                d3.select('#velocityArrowHead').selectAll('line')
                    .data(d3.range(2))
                    .enter().append('line')
                    .attr('x2', -arrowOffset)
                    .attr('y2', function(d) {return (d ? -1 : 1)*arrowOffset; });
            }

            function initLineBody() {
                // horizontal line
                d3.select('#triangle').append('line')
                    .attr('id', 'horizontalVel')
                    .classed('split', true)
                    .classed('splitLine', true);
                // vertical line
                d3.select('#triangleRight').append('line')
                    .attr('id', 'verticalVel')
                    .classed('split', true)
                    .classed('splitLine', true);
                // vector line
                d3.select('#velocity').append('line')
                    .attr('id', 'vectorLineBody');
            }

            function initBall() {

                // draggable ball
                d3.select('#triangle').append('circle')
                    .attr('r', velBall.r)
                    .attr('id', 'velBall')
                    .style('fill-opacity', 0.3)
                    .style('fill', '#2c8f9c')
                    .call(d3.drag()
                        .on("start", dragStart)
                        .on("drag", dragVelBall)
                        .on("end", dragEnd));
            }

        }

    }

    function initButtons() {

        const buttonOffset = {'playX': 150, 'pauseX': 100, 'resetX': 50, 'y': 20, 'line': 8};
        const button = {'size': 30, 'rx': 5};
        const resetRadius = 8;
        const buttonArrowOffset = 4;

        svg.append('g')
            .attr('transform', 'translate(' + (width - buttonOffset.playX) + ',' + buttonOffset.y + ')')
            .attr('id', 'playContainer')
            .on('click', clickPlay);
        d3.select('#playContainer').append('rect')
            .attr('height', button.size)
            .attr('width', button.size)
            .attr('rx', button.rx)
            .attr('fill', '#75b4be')
            .attr('id', 'play')
            .classed('active', animate);
        d3.select('#playContainer').append('path')
            .attr('d', 'M ' + buttonOffset.line + ' ' + buttonOffset.line + ' L ' + buttonOffset.line + ' ' + (button.size - buttonOffset.line) + ' L ' + (button.size - buttonOffset.line) + ' ' + (button.size/2) + ' Z')
            .style('fill', '#fff');

        svg.append('g')
            .attr('transform', 'translate(' + (width - buttonOffset.pauseX) + ',' + buttonOffset.y + ')')
            .attr('id', 'pauseContainer')
            .on('click', clickPause);
        d3.select('#pauseContainer').append('rect')
            .attr('height', button.size)
            .attr('width', button.size)
            .attr('rx', button.rx)
            .attr('fill', '#75b4be')
            .attr('id', 'pause')
            .classed('active', !animate);
        d3.select('#pauseContainer').selectAll('line')
            .data(d3.range(2))
            .enter().append('line')
            .attr('x1', function (d) {
                return (d + 1) * (button.size / 3);
            })
            .attr('y1', buttonOffset.line)
            .attr('x2', function (d) {
                return (d + 1) * (button.size / 3);
            })
            .attr('y2', button.size - buttonOffset.line)
            .style('stroke', '#fff')
            .style('stroke-width', (button.size/6) + 'px');

        svg.append('g')
            .attr('transform', 'translate(' + (width - buttonOffset.resetX) + ',' + buttonOffset.y + ')')
            .attr('id', 'resetContainer')
            .on('click', clickReset);
        d3.select('#resetContainer').append('rect')
            .attr('height', button.size)
            .attr('width', button.size)
            .attr('rx', button.rx)
            .attr('fill', '#75b4be')
            .attr('id', 'reset')
            .classed('active', false);
        d3.select('#resetContainer').append('g')
            .attr('id', 'resetSymbol');
        d3.select('#resetSymbol').append('clipPath')
            .attr('id', 'clipReset')
            .append('path')
            .attr('d', 'M ' + 0 + ' ' + 0 + ' L ' + button.size/2 + ' ' + 0 + ' L ' + button.size/2 + ' ' + button.size/3 +
                ' L ' + button.size + ' ' + button.size/3 + ' L ' + button.size + ' ' + button.size + ' L ' + 0 + ' ' + button.size + ' Z')
            .attr('id', 'clipPathReset');
        d3.select('#resetSymbol').append('circle')
            .attr('cx', button.size/2)
            .attr('cy', button.size/2)
            .attr('r', resetRadius)
            .attr('clip-path', 'url(#clipReset)')
            .style('fill-opacity', 0)
            .style('stroke-opacity', 1)
            .style('stroke', '#fff')
            .style('stroke-width', '2px');
        d3.select('#resetSymbol').append('g')
            .attr('transform', 'translate(' + button.size/2 + ',' + (button.size/2 - resetRadius + 1) + ')')
            .attr('id', 'resetArrowHead');
        d3.select('#resetArrowHead').selectAll('line')
            .data(d3.range(2))
            .enter().append('line')
            .attr('x2', -buttonArrowOffset)
            .attr('y2', function(d) {return (d ? -1 : 1) * buttonArrowOffset; })
            .style('stroke', '#fff')
            .style('stroke-width', '2px');

    }


    // Animation
    function animateBall() {
        if (animate) {
            const g = -9.81;

            var t = (Date.now() - start)/100;

            // x = ut + (1/2)at^2 + (starting position)
            var tempX = vectorCoords.x*t + ballDim.x;
            var tempY = vectorCoords.y*t + (1/2)*(g)*Math.pow(t, 2) + ballDim.y;

            if (t >= markerCount) {
                d3.select('#flightPath').append('circle')
                    .attr('r', 2)
                    .attr('cx', tempX)
                    .attr('cy', height - tempY)
                    .style('fill', colour(launchCount % 10));

                markerCount += 0.1;
            }

            d3.select('#ball')
                .attr('cx', tempX)
                .attr('cy', height - tempY);

            if (tempX > (width + 2*ballDim.r) || tempY < -2*ballDim.r) {
                clickPause();
                resetBall();
            }
        }
    }


    // On click
    function clickPlay() {
        d3.select('#play').classed('active', true);
        d3.select('#pause').classed('active', false);

        launchCount += (mem == 0 && !animate) ? 1 : 0;

        start = animate ? start : (Date.now() - mem);
        animate = true;
    }

    function clickPause() {
        d3.select('#play').classed('active', false);
        d3.select('#pause').classed('active', true);

        if (animate) {
            mem = Date.now() - start;
            animate = false;
        }
    }

    function clickReset() {
        d3.select('#reset').classed('active', true);
        launchCount = 0;
        setTimeout(function() {d3.select('#reset').classed('active', false); }, 200);
        clickPause();
        d3.select('#flightPath').selectAll('circle').remove();
        resetBall();
    }


    // On drag
    function dragStart() {
        d3.select(this).classed("active", true);
    }

    function dragActiveBall() {
        if (!animate) {
            const lim = {'minY': ballDim.r, 'maxY': height-ballDim.r};

            ballDim.y = height - Math.max(Math.min(d3.event.y, lim.maxY), lim.minY);

            d3.select('#shadowBall')
                .attr('cy', height - ballDim.y);

            d3.select('#ball')
                .attr('cy', height - ballDim.y);

            updateHeightArrow();

            d3.select('#triangle').attr('transform', 'translate(' + ballDim.x + ',' + (height-ballDim.y) + ')');
            if (ballDim.y + vectorCoords.y > (height-velBall.r)) {
                vectorCoords.y = height - ballDim.y - velBall.r;
                updateTriangle();
            }
        }
    }

    function dragVelBall() {
        if (!animate) {
            var lim = {'minX': 0, 'minY': 0, 'maxX': width - ballDim.x - velBall.r, 'maxY': height - ballDim.y - velBall.r};

            var tempX = Math.max(Math.min(d3.event.x, lim.maxX), lim.minX);
            var tempY = Math.max(Math.min(-d3.event.y, lim.maxY), lim.minY);
            var tempR = Math.sqrt(Math.pow(tempX,2) + Math.pow(tempY,2));

            if ((tempR - velBall.r) >= ballDim.r) {
                vectorCoords.x = Math.max(Math.min(d3.event.x, lim.maxX), lim.minX);
                vectorCoords.y = Math.max(Math.min(-d3.event.y, lim.maxY), lim.minY);
            }

            updateTriangle();
        }
    }

    function dragEnd() {
        d3.select(this).classed("active", false);
    }


    // Updates and resets
    function resetBall() {
        d3.select('#ball')
            .style('fill-opacity', 0)
            .attr('cx', ballDim.x)
            .attr('cy', height - ballDim.y)
            .transition()
            .duration(500)
            .style('fill-opacity', 1);

        mem = 0;
        markerCount = 0;
    }

    function updateTriangle() {

        const dragOffset = 4;
        const rad2deg = 180/Math.PI;
        const deg2rad = 1/rad2deg;

        var vel = Math.sqrt(Math.pow(vectorCoords.x,2) + Math.pow(vectorCoords.y,2));
        var angle = Math.atan(vectorCoords.y/vectorCoords.x)*rad2deg;

        updateContainers();
        updateLineBodies();

        d3.select('#velBall')
            .attr('cx', vectorCoords.x - dragOffset*Math.cos(angle*deg2rad))
            .attr('cy', -vectorCoords.y + dragOffset*Math.sin(angle*deg2rad));

        function updateContainers() {

            d3.select('#triangleRight').attr('transform', 'translate(' + vectorCoords.x + ',0)');
            d3.select('#triangleTop').attr('transform', 'translate(0,' + (-vectorCoords.y) + ')');
            d3.select('#velocity').attr('transform', 'rotate(' + (-angle) + ')');
            d3.select('#velocityArrowHead').attr('transform', 'translate(' + vel + ',0)');

        }

        function updateLineBodies() {

            d3.select('#vectorLineBody').attr('x2', vel);
            d3.select('#horizontalVel').attr('x2', vectorCoords.x);
            d3.select('#verticalVel').attr('y2', -vectorCoords.y);

        }

    }

    function updateHeightArrow() {
        var arrowHeight = ballDim.y - ballDim.r;

        d3.select('#heightLineBody').attr('y2', -arrowHeight);

        d3.select('#heightArrowHeadContainer')
            .style('stroke-opacity', (arrowHeight <= 2*arrowOffset ? 0 : 1));

        d3.select('#heightTopArrowHeadContainer')
            .attr('transform', 'translate(0,' + (-arrowHeight) + ')')
            .style('stroke-opacity', (arrowHeight <= arrowOffset ? 0 : 1));
    }


</script>

</body>
</html>