<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fourth Formula</title>

    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="../scripts/styles.css">

</head>
<body>

<div id="wrapper">
    <div id="container">
        <div id="animation"></div>
        <div id="control"></div>
    </div>
</div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="../scripts/animationEls.js" type="text/javascript"></script>
<script src="../scripts/curtain.js" type="text/javascript"></script>
<script src="../scripts/actionButtons.js" type="text/javascript"></script>
<script src="../scripts/formula.js" type="text/javascript"></script>
<script src="../scripts/radioButtons.js" type="text/javascript"></script>
<script src="../scripts/dragButtons.js" type="text/javascript"></script>

<script>

    const height = 350;
    const animationWidth = 700;
    const controlWidth = 200;

    const scalingFactor = 29;
    const distScale = 4;

    var eqVars = [{'name': 'xz', 'active': 90, 'eq': 'x = ', 'measure': 'm'},
                  {'name': 'u', 'active': 60, 'eq': 'u = ', 'measure': 'm/s'},
                  {'name': 'v2', 'active': 120, 'eq': 'v = ', 'measure': 'm/s'}];

    init();

    function init() {

        var animation = {'start': Date.now(), 'mem': 0, 'state': false};

        var animationSvg = d3.select('div#animation').append('svg')
            .attr('width', animationWidth)
            .attr('height', height)
            .attr('overflow', 'hidden');

        var controlSvg = d3.select('div#control').append('svg')
            .attr('height', height)
            .attr('width', controlWidth)
            .style('border', 'solid black 2px');

        const ballRadius = 38;
        const ballOffset = 180 - ballRadius;
        animationSvg.append('g')
            .attr('transform', 'translate(' + ballRadius + ',' + (height - ballOffset) + ')')
            .attr('id', 'ballContainer');

        const num = 20;
        initCurtain(ballRadius, num);

        initBall(ballRadius);

        const formula = ['x', '=', 'Â½', '(', 'u', '+', 'v', ')', 't'];
        const textGap = [0, 30, 30, 45, 15, 35, 33, 27, 20];
        initFormula(animationSvg, formula, textGap);

        controlSvg.append('g')
            .attr('transform', 'translate(0,' + (65) + ')')
            .attr('id', 'radioContainer');
        initFormulaRadio(d3.select('#radioContainer'));

        const dotsNum = 2;
        initDots(dotsNum, true);

        controlSvg.append('g')
            .attr('transform', 'translate(0,' + (-10) + ')')
            .attr('id', 'buttonContainer');
        initButtons(d3.select('#buttonContainer'), animation);

        controlSvg.append('g')
            .attr('transform', 'translate(0,' + (height - 165) + ')')
            .attr('id', 'dragContainer');
        initDrag(d3.select('#dragContainer'));

        d3.timer(animateBall);

        // Animate
        function animateBall() {
            if (animation.state) {
                var secondCount = (Date.now() - animation.start) / 1000;

                // t = 2*x/(v+u)
                var t = 2*distScale*convert(eqVars[0].active)/(convert(eqVars[1].active)+convert(eqVars[2].active));
                // a = (v-u)/t
                var acc = (convert(eqVars[2].active)-convert(eqVars[1].active))/t;
                // x = u*t + 1/2*a*t^2
                var loc = convert(eqVars[1].active)*secondCount + (1/2)*acc*Math.pow(secondCount,2);
                // v = u + at
                var scaledVel = Math.floor(eqVars[1].active/scalingFactor) + (acc > 0 ? Math.floor((acc/scalingFactor)*secondCount) : Math.ceil((acc/scalingFactor)*secondCount));

                d3.select('#ball').attr('cx', loc);

                if (d3.select('#numbersRadio').classed('active')) updateNumbers(Math.floor(secondCount*10)/10, scaledVel);

                if (loc >= distScale*convert(eqVars[0].active)) {
                    d3.select('#ball').attr('cx', distScale*convert(eqVars[0].active));
                    clickPause(animation);
                    setTimeout(function() {resetBall(animation); }, 500);
                }
            }
        }
    }

    function updateDots(index) {

        const dotScalingFactor = 1/2;

        var numDots = d3.select('#dots').selectAll('circle').size();

        for(var n=0; n<numDots; n++) {
            d3.select('#topText' + n).text(Math.floor(eqVars[n + 1].active / scalingFactor) + 'm/s');
            d3.select('#dotLineBody' + n).attr('x2', convert(eqVars[n + 1].active) * dotScalingFactor + scalingFactor);
            d3.select('#arrowHead' + n).attr('transform', 'translate(' + (convert(eqVars[n + 1].active) * dotScalingFactor + scalingFactor) + ',0)');
            d3.select('#bottomText' + n).text(distScale*Math.floor(eqVars[0].active/scalingFactor)*n + 'm');
        }

        d3.select('#dots1')
            .transition()
            .duration(750)
            .attr('transform', 'translate(' + distScale*convert(eqVars[0].active) + ',0)');
    }

    function updateDrag(index) {

        index = index || 0;

        d3.select('#' + eqVars[index].name + 'Text').text(eqVars[index].eq + (index ? 1 : distScale)*Math.floor(eqVars[index].active/scalingFactor) + eqVars[index].measure);
        d3.select('#' + eqVars[index].name + 'LineBody').attr('x2', eqVars[index].active);
        d3.select('#' + eqVars[index].name + 'DraggableContainer').attr('transform', 'translate(' + eqVars[index].active + ',0)');

        // a = (v^2 - u^2)/2x
        var acc = (Math.pow(convert(eqVars[2].active), 2) - Math.pow(convert(eqVars[1].active), 2))/(2*convert(eqVars[0].active)*distScale);

        updateDistCurtain(acc, convert(eqVars[1].active), convert(eqVars[0].active)*distScale);
    }

    // Utils
    function convert(input) {
        return Math.floor(input/scalingFactor)*scalingFactor;
    }

</script>

</body>
</html>