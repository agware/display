<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Projectile2</title>

    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="../scripts/styles.css">

</head>
<body>

<div id="wrapper">
    <div id="container">
        <div id="animation"></div>
        <div id="control"></div>
    </div>
</div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="../scripts/actionButtons.js" type="text/javascript"></script>
<script src="../scripts/radioButtons.js" type="text/javascript"></script>

<script>

    const height = 500;
    const animationWidth = 700;
    const controlWidth = 200;

    const velBall = {'r': 15};
    const ballDim = {'x': 50, 'y': 100, 'r': 20};
    const vectorCoords = {'x': 50, 'y': 50};
    const arrowOffset = 8;
    const colour = d3.scaleOrdinal(d3.schemeCategory10);

    var markerCount = 1;
    var animation = {'start': Date.now(), 'mem': 0, 'state': false};

    init();

    function init() {
        var animationSvg = d3.select('div#animation').append('svg')
            .attr('width', animationWidth)
            .attr('height', height)
            .attr('overflow', 'hidden')
            .style('border', '1px solid black');

        var controlSvg = d3.select('div#control').append('svg')
            .attr('width', controlWidth)
            .attr('height', height)
            .attr('overflow', 'hidden')
            .style('border', '1px solid black');

        initArrows();
        initBall();

        initButtons(controlSvg, animation, true);

        const ids = ['horizontal', 'vertical', 'both'];
        controlSvg.append('g')
            .attr('transform', 'translate(0,' + (90) + ')')
            .attr('id', 'radioContainer');
        initRadio(d3.select('#radioContainer'), ids);

        d3.select('#verticalRadio').on('click', clickVertical);
        d3.select('#horizontalRadio').on('click', clickHorizontal);
        d3.select('#bothRadio').on('click', clickBoth);

        initVariables();

        d3.timer(animateBall);

        function initArrows() {

            initHeightArrow();
            initTriangle();

            function initHeightArrow() {
                animationSvg.append('g')
                    .attr('transform', 'translate(' + ballDim.x + ',' + height + ')')
                    .attr('id', 'heightArrowContainer');

                d3.select('#heightArrowContainer').append('line')
                    .attr('id', 'heightLineBody');

                initArrowHeads();

                updateHeightArrow();

                function initArrowHeads() {
                    d3.select('#heightArrowContainer').append('g')
                        .attr('id', 'heightArrowHeadContainer');

                    d3.select('#heightArrowHeadContainer').selectAll('line')
                        .data(d3.range(2))
                        .enter().append('line')
                        .attr('x2', function(d) {return (d ? -1 : 1) * arrowOffset; })
                        .attr('y2', -arrowOffset);

                    d3.select('#heightArrowContainer').append('g')
                        .attr('id', 'heightTopArrowHeadContainer');

                    d3.select('#heightTopArrowHeadContainer').selectAll('line')
                        .data(d3.range(2))
                        .enter().append('line')
                        .attr('x2', function(d) {return (d ? -1 : 1) * arrowOffset; })
                        .attr('y2', arrowOffset);
                }
            }

            function initTriangle() {

                initTriangleContainers();
                initArrowHead();
                initLineBody();
                initBall();

                updateTriangle();

                function initTriangleContainers() {
                    animationSvg.append('g')
                        .attr('transform', 'translate(' + ballDim.x + ',' + (height-ballDim.y) + ')')
                        .attr('id', 'triangle');
                    d3.select('#triangle').append('g')
                        .attr('id', 'velocity');
                    d3.select('#velocity').append('g')
                        .attr('id', 'velocityArrowHead');
                }

                function initArrowHead() {
                    // vector arrowHead
                    d3.select('#velocityArrowHead').selectAll('line')
                        .data(d3.range(2))
                        .enter().append('line')
                        .attr('x2', -arrowOffset)
                        .attr('y2', function(d) {return (d ? -1 : 1)*arrowOffset; });
                }

                function initLineBody() {
                    // vector line
                    d3.select('#velocity').append('line')
                        .attr('id', 'vectorLineBody');
                }

                function initBall() {

                    // draggable ball
                    d3.select('#triangle').append('circle')
                        .attr('r', velBall.r)
                        .attr('id', 'velBall')
                        .style('fill-opacity', 0.3)
                        .classed('clickable', true)
                        .call(d3.drag()
                            .on("start", dragStart)
                            .on("drag", dragVelBall)
                            .on("end", dragEnd));
                }

            }

        }
        function initBall() {

            var launchCount = 0;
            animationSvg.append('g')
                .attr('id', 'flightPath')
                .datum(launchCount);

            animationSvg.append('circle')
                .attr('cx', ballDim.x)
                .attr('cy', height - ballDim.y)
                .attr('r', ballDim.r)
                .attr('id', 'shadowBall')
                .style('fill-opacity', 0.3);

            animationSvg.append('circle')
                .attr('r', ballDim.r)
                .attr('id', 'ball')
                .classed('clickable', true)
                .call(d3.drag()
                    .on("start", dragStart)
                    .on("drag", dragActiveBall)
                    .on("end", dragEnd))
                .on("mouseover", mouseOver)
                .on("mouseout", mouseOut);

            resetBall(animation);
        }

        function initVariables() {
            const variableOffset = {'containerY': 250, 'containerGap': 120, 'underlineX': 70, 'underlineY': 10, 'underlineLen': 60,
                'lineY': 70, 'velLineX': 40, 'velLineGap': 100, 'accLineX': 100, 'accLineLen': 40, 'text': controlWidth/2 - 10};
            const variableText = ['u', 'a'];

            controlSvg.append('g')
                .attr('transform', 'translate(0,' + variableOffset.containerY + ')')
                .attr('id', 'variableContainer');

            initHeadings();
            initVelArrows();
            initAccArrows();

            function initHeadings() {
                d3.select('#variableContainer').selectAll('g')
                    .data(d3.range(variableText.length))
                    .enter().append('g')
                    .attr('transform', function(d) {return 'translate(0,' + (variableOffset.containerGap * d) + ')'; })
                    .attr('id', function(d) {return variableText[d] + 'Container'; });

                console.log(variableText);

                for (var i = 0; i < variableText.length; i++) {
                    d3.select('#' + variableText[i] + 'Container').append('text')
                        .attr('x', variableOffset.text)
                        .text(variableText[i])
                        .style('font-size', '40px');
                    d3.select('#' + variableText[i] + 'Container').append('line')
                        .attr('transform', 'translate(' + variableOffset.underlineX + ',' + variableOffset.underlineY + ')')
                        .attr('x2', variableOffset.underlineLen);
                }
            }

            function initVelArrows() {
                d3.select('#uContainer').append('g')
                    .attr('transform', 'translate(' + variableOffset.velLineX + ',' + variableOffset.lineY + ')')
                    .attr('id', 'velContainer');

                d3.select('#velContainer').append('line')
                    .attr('id', 'horizontalVel');

                d3.select('#velContainer').append('g')
                    .attr('id', 'horizontalArrowHeadContainer');
                d3.select('#horizontalArrowHeadContainer').selectAll('line')
                    .data(d3.range(2))
                    .enter().append('line')
                    .attr('x2', -arrowOffset/2)
                    .attr('y2', function(d) {return (d ? -1 : 1) * arrowOffset/2; });

                d3.select('#velContainer').append('g')
                    .attr('transform', 'translate(' + variableOffset.velLineGap + ',0)')
                    .attr('id', 'verticalVelContainer');
                d3.select('#verticalVelContainer').append('line')
                    .attr('id', 'verticalVel');

                d3.select('#verticalVelContainer').append('g')
                    .attr('id', 'verticalArrowHeadContainer');
                d3.select('#verticalArrowHeadContainer').selectAll('line')
                    .data(d3.range(2))
                    .enter().append('line')
                    .attr('x2', function(d) {return (d ? -1 : 1) * arrowOffset/2; })
                    .attr('y2', arrowOffset/2);
            }

            function initAccArrows() {
                d3.select('#aContainer').append('g')
                    .attr('transform', 'translate(' + variableOffset.accLineX + ',' + variableOffset.lineY + ')')
                    .attr('id', 'accContainer');

                d3.select('#accContainer').append('line')
                    .attr('y2', -variableOffset.accLineLen);
                d3.select('#accContainer').append('g')
                    .attr('id', 'accArrowHeadContainer');
                d3.select('#accArrowHeadContainer').selectAll('line')
                    .data(d3.range(2))
                    .enter().append('line')
                    .attr('x2', function(d) {return (d ? -1 : 1) * arrowOffset/2; })
                    .attr('y2', -arrowOffset/2);
            }

            updateLines();

        }

        function animateBall() {
            if (animation.state) {
                const g = -9.81;
                const velArrowOffset = 5;

                var t = (Date.now() - animation.start)/100;

                if (t >= markerCount) {
                    // x = ut + (1/2)at^2 + (starting position)
                    var tempX = vectorCoords.x*markerCount + ballDim.x;
                    var tempY = vectorCoords.y*markerCount + (1/2)*(g)*Math.pow(markerCount, 2) + ballDim.y;

                    // v = u + at
                    var tempVelX = vectorCoords.x;
                    var tempVelY = vectorCoords.y + g*markerCount;

                    var launchCount = d3.select('#flightPath').datum();

                    d3.select('#flightPath').append('g')
                        .attr('transform', 'translate(' + tempX + ',' + (height-tempY) + ')')
                        .attr('id', 'flight' + launchCount + 'container' + markerCount);

                    d3.select('#flight' +  launchCount + 'container' + markerCount).append('circle')
                        .attr('r', 5)
                        .style('fill', colour(launchCount % 10));

                    if (tempVelX > velArrowOffset) {
                        d3.select('#flight' + launchCount + 'container' + markerCount).append('g')
                            .attr('transform', 'translate(' + tempVelX + ',0)')
                            .attr('id', 'x' + launchCount + 'container' + markerCount)
                            .classed('horizontalLine', true);
                        d3.select('#x' + launchCount + 'container' + markerCount).selectAll('line')
                            .data(d3.range(2))
                            .enter().append('line')
                            .attr('x2', -velArrowOffset)
                            .attr('y2', function(d) {return (d ? -1 : 1)*velArrowOffset; });
                        d3.select('#x' + launchCount + 'container' + markerCount).append('line')
                            .attr('x2', -tempVelX);
                    }

                    if (tempVelY > velArrowOffset || tempVelY < -velArrowOffset) {
                        d3.select('#flight' + launchCount + 'container' + markerCount).append('g')
                            .attr('transform', 'translate(0,' + (-tempVelY) + ')')
                            .attr('id', 'y' + launchCount + 'container' + markerCount)
                            .classed('verticalLine', true);
                        d3.select('#y' + launchCount + 'container' + markerCount).selectAll('line')
                            .data(d3.range(2))
                            .enter().append('line')
                            .attr('x2', function(d) {return (d ? -1 : 1)*velArrowOffset; })
                            .attr('y2', tempVelY > 0 ? velArrowOffset : -velArrowOffset);
                        d3.select('#y' + launchCount + 'container' + markerCount).append('line')
                            .attr('y2', tempVelY);
                    }

                    updateLineVisibility();

                    markerCount += 2;
                }

                // x = ut + (1/2)at^2 + (starting position)
                var dimX = vectorCoords.x*t + ballDim.x;
                var dimY = vectorCoords.y*t + (1/2)*(g)*Math.pow(t, 2) + ballDim.y;

                d3.select('#ball')
                    .attr('cx', dimX)
                    .attr('cy', height - dimY);

                if (tempX > (animationWidth + 2*ballDim.r) || tempY < -2*ballDim.r) {
                    clickPause(animation);
                    resetBall(animation);
                }
            }
        }
    }

    function clickHorizontal () {
        d3.select('#radiohorizontal').selectAll('circle').classed('active', false);
        d3.select('#horizontalRadio').classed('active', true);

        updateLineVisibility();
    }

    function clickVertical() {
        d3.select('#radiohorizontal').selectAll('circle').classed('active', false);
        d3.select('#verticalRadio').classed('active', true);

        updateLineVisibility();
    }

    function clickBoth() {
        d3.select('#radiohorizontal').selectAll('circle').classed('active', false);
        d3.select('#bothRadio').classed('active', true);

        updateLineVisibility();
    }


    // On drag
    function dragStart() {
        d3.select(this).classed("active", true);
    }

    function dragActiveBall() {
        if (!animation.state) {
            const lim = {'minY': ballDim.r, 'maxY': height-ballDim.r};

            ballDim.y = height - Math.max(Math.min(d3.event.y, lim.maxY), lim.minY);

            d3.select('#shadowBall')
                .attr('cy', height - ballDim.y);

            d3.select('#ball')
                .attr('cy', height - ballDim.y);

            updateHeightArrow();

            d3.select('#triangle').attr('transform', 'translate(' + ballDim.x + ',' + (height-ballDim.y) + ')');
            if (ballDim.y + vectorCoords.y > (height-velBall.r)) {
                vectorCoords.y = height - ballDim.y - velBall.r;
                updateTriangle();
            }
        }
    }

    function dragVelBall() {
        if (!animation.state) {
            var lim = {'minX': 0, 'minY': 0, 'maxX': 100, 'maxY': 100};

            var tempX = Math.max(Math.min(d3.event.x, lim.maxX), lim.minX);
            var tempY = Math.max(Math.min(-d3.event.y, lim.maxY), lim.minY);
            var tempR = Math.sqrt(Math.pow(tempX,2) + Math.pow(tempY,2));

            if ((tempR - velBall.r) >= ballDim.r) {
                vectorCoords.x = Math.max(Math.min(d3.event.x, lim.maxX), lim.minX);
                vectorCoords.y = Math.max(Math.min(-d3.event.y, lim.maxY), lim.minY);
            }


            updateTriangle();
            updateLines();
        }
    }

    function dragEnd() {
        d3.select(this).classed("active", false);
    }


    // On mouse over
    function mouseOver() {
        d3.select(this).classed('hover', true);
    }

    function mouseOut() {
        d3.select(this).classed('hover', false);
    }


    // Updates and resets
    function resetBall(animation) {
        d3.select('#ball')
            .style('fill-opacity', 0)
            .attr('cx', ballDim.x)
            .attr('cy', height - ballDim.y)
            .transition()
            .duration(500)
            .style('fill-opacity', 1);

        animation.mem = 0;
        markerCount = 1;
    }

    function updateTriangle() {

        const dragOffset = 4;
        const rad2deg = 180/Math.PI;
        const deg2rad = 1/rad2deg;

        var vel = Math.sqrt(Math.pow(vectorCoords.x,2) + Math.pow(vectorCoords.y,2));
        var angle = Math.atan(vectorCoords.y/vectorCoords.x)*rad2deg;

        updateContainers();
        updateLineBodies();

        d3.select('#velBall')
            .attr('cx', vectorCoords.x - dragOffset*Math.cos(angle*deg2rad))
            .attr('cy', -vectorCoords.y + dragOffset*Math.sin(angle*deg2rad));

        function updateContainers() {

            d3.select('#velocity').attr('transform', 'rotate(' + (-angle) + ')');
            d3.select('#velocityArrowHead').attr('transform', 'translate(' + vel + ',0)');

        }

        function updateLineBodies() {

            d3.select('#vectorLineBody').attr('x2', vel);

        }

    }

    function updateHeightArrow() {
        var arrowHeight = ballDim.y - ballDim.r;

        d3.select('#heightLineBody').attr('y2', -arrowHeight);

        d3.select('#heightArrowHeadContainer')
            .style('stroke-opacity', (arrowHeight <= 2*arrowOffset ? 0 : 1));

        d3.select('#heightTopArrowHeadContainer')
            .attr('transform', 'translate(0,' + (-arrowHeight) + ')')
            .style('stroke-opacity', (arrowHeight <= arrowOffset ? 0 : 1));
    }

    function updateLineVisibility() {
        if (d3.select('#horizontalRadio').classed('active')) {
            d3.selectAll('.horizontalLine').attr('stroke-opacity', 1);
            d3.selectAll('.verticalLine').attr('stroke-opacity', 0);
        } else if (d3.select('#verticalRadio').classed('active')) {
            d3.selectAll('.horizontalLine').attr('stroke-opacity', 0);
            d3.selectAll('.verticalLine').attr('stroke-opacity', 1);
        } else {
            d3.selectAll('.horizontalLine').attr('stroke-opacity', 1);
            d3.selectAll('.verticalLine').attr('stroke-opacity', 1);
        }
    }

    function updateLines() {
        d3.select('#horizontalVel')
            .attr('x2', vectorCoords.x/2);
        d3.select('#horizontalArrowHeadContainer')
            .attr('transform', 'translate(' + vectorCoords.x/2 + ',0)')
            .style('stroke-opacity', (vectorCoords.x < 2) ? 0 : 1);

        d3.select('#verticalVel')
            .attr('y2', -vectorCoords.y/2);
        d3.select('#verticalArrowHeadContainer')
            .attr('transform', 'translate(0,' + (-vectorCoords.y/2) + ')')
            .style('stroke-opacity', (vectorCoords.y < 2) ? 0 : 1);
    }

</script>

</body>
</html>