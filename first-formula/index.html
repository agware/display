<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>First Formula</title>

    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="../scripts/styles.css">

</head>
<body>

<div id="wrapper">
    <div id="container">
        <div id="animation"></div>
        <div id="control"></div>
    </div>
</div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="../scripts/animationEls.js" type="text/javascript"></script>
<script src="../scripts/curtain.js" type="text/javascript"></script>
<script src="../scripts/actionButtons.js" type="text/javascript"></script>
<script src="../scripts/formula.js" type="text/javascript"></script>
<script src="../scripts/radioButtons.js" type="text/javascript"></script>
<script src="../scripts/dragButtons.js" type="text/javascript"></script>

<script>

    const height = 350;
    const animationWidth = 700;
    const controlWidth = 200;

    const scalingFactor = 30;

    var eqVars = [{'name': 'u', 'active': 90, 'eq': 'u = ', 'measure': 'm/s'},
                  {'name': 'a', 'active': 60, 'eq': 'a = ', 'measure': 'm/s²'}];

    init();

    function init() {
        var animation = {'start': Date.now(), 'mem': 0, 'state': false};

        var animationSvg = d3.select('div#animation').append('svg')
            .attr('width', animationWidth)
            .attr('height', height)
            .attr('overflow', 'hidden');


        var controlSvg = d3.select('div#control').append('svg')
            .attr('height', height)
            .attr('width', controlWidth)
            .attr('overflow', 'hidden')
            .style('border', 'solid black 2px');

        const ballRadius = 38;
        const ballOffset = 180 - ballRadius;
        animationSvg.append('g')
            .attr('transform', 'translate(' + ballRadius + ',' + (height - ballOffset) + ')')
            .attr('id', 'ballContainer');

        const num = 6;
        initCurtain(ballRadius, num);

        initBall(ballRadius);

        const formula = ['v', '=', 'u', '+', 'a', '•', 't'];
        const textGap = [0, 30, 30, 32, 32, 28, 20];
        initFormula(animationSvg, formula, textGap);

        controlSvg.append('g')
            .attr('transform', 'translate(0,' + (100) + ')')
            .attr('id', 'radioContainer');
        initFormulaRadio(d3.select('#radioContainer'));

        initDots(num, true);

        initButtons(controlSvg, animation);

        controlSvg.append('g')
            .attr('transform', 'translate(0,' + (height - 110) + ')')
            .attr('id', 'dragContainer');
        initDrag(d3.select('#dragContainer'));

        d3.timer(animateBall);

        function animateBall() {
            if (animation.state) {
                var secondCount = (Date.now() - animation.start) / 1000;

                // x = ut + (1/2)at^2
                var loc = convert(eqVars[0].active) * secondCount + (1 / 2) * convert(eqVars[1].active) * Math.pow(secondCount, 2);

                d3.select('#ball').attr('cx', loc);

                if (loc > animationWidth + parseInt(d3.select('#ball').attr('r'))) {
                    clickPause(animation);
                    resetBall(animation);
                    secondCount = 0;
                }

                if (d3.select('#numbersRadio').classed('active')) {
                    updateNumbers(Math.floor(secondCount));
                }
            }
        }
    }

    function updateDots() {

        const dotScalingFactor = 1/6;

        var numDots = d3.select('#dots').selectAll('circle').size();

        for (var k = 0; k < numDots; k++) {
            d3.select('#dots' + k)
                .transition()
                .duration(750)
                .attr('transform', 'translate(' + (convert(eqVars[0].active)*k + (1/2)*convert(eqVars[1].active)*Math.pow(k,2)) + ',0)');
            d3.select('#dotLineBody' + k)
                .transition()
                .attr('x2', (convert(eqVars[0].active) + convert(eqVars[1].active)*k)*dotScalingFactor + 30);
            d3.select('#arrowHead' + k)
                .transition()
                .attr('transform', 'translate(' + ((convert(eqVars[0].active) + convert(eqVars[1].active)*k)*dotScalingFactor + 30) + ',0)');
            d3.select('#topText' + k).text((convert(eqVars[0].active)/scalingFactor + k*convert(eqVars[1].active)/scalingFactor) + 'm/s');
            d3.select('#bottomText' + k).text(k + 's');
        }
    }

    function updateDrag(index) {
        index = index || 0;

        d3.select('#' + eqVars[index].name + 'Text').text(eqVars[index].eq + Math.floor(eqVars[index].active/scalingFactor) + eqVars[index].measure);
        d3.select('#' + eqVars[index].name + 'LineBody').attr('x2', eqVars[index].active);
        d3.select('#' + eqVars[index].name + 'DraggableContainer').attr('transform', 'translate(' + eqVars[index].active + ',0)');

    updateCurtain(convert(eqVars[1].active), convert(eqVars[0].active));
    }

    // Utils
    function convert(input) {
        return Math.floor(input/scalingFactor)*scalingFactor;
    }

</script>

</body>
</html>