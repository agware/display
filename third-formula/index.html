<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Third Formula</title>

    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="../scripts/styles.css">

</head>
<body>

<div id="wrapper">
    <div id="container">
        <div id="animation"></div>
        <div id="control"></div>
    </div>
</div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="../scripts/animationEls.js" type="text/javascript"></script>
<script src="../scripts/actionButtons.js" type="text/javascript"></script>
<script src="../scripts/formula.js" type="text/javascript"></script>
<script src="../scripts/radioButtons.js" type="text/javascript"></script>
<script src="../scripts/dragButtons.js" type="text/javascript"></script>

<script>

    const height = 350;
    const animationWidth = 700;
    const controlWidth = 200;

    const scalingFactor = 29;
    const distScale = 4;

    var eqVars = [{'name': 'x2', 'active': 90, 'eq': 'x = ', 'measure': 'm'},
                  {'name': 'u', 'active': 90, 'eq': 'u = ', 'measure': 'm/s'},
                  {'name': 'a', 'active': 90, 'eq': 'a = ', 'measure': 'm/s²'}];

    init();

    function init() {
        var animation = {'start': Date.now(), 'mem': 0, 'state': true};

        var animationSvg = d3.select('div#animation').append('svg')
            .attr('width', animationWidth)
            .attr('height', height)
            .attr('overflow', 'hidden');

        var controlSvg = d3.select('div#control').append('svg')
            .attr('height', height)
            .attr('width', controlWidth)
            .attr('overflow', 'hidden')
            .style('border', 'solid black 2px');

        const ballRadius = 38;
        initBall(animationSvg, ballRadius);

        const formula = ['v', '²', '=', 'u', '²', '+', '2', '•', 'a', '•', 'x'];
        const textGap = [0, 30, 25, 35, 35, 25, 30, 30, 20, 30, 20];
        initFormula(animationSvg, formula, textGap);

        controlSvg.append('g')
            .attr('transform', 'translate(0,' + (65) + ')')
            .attr('id', 'radioContainer');
        initFormulaRadio(d3.select('#radioContainer'));

        const num = 2;
        initDots(num, true);

        controlSvg.append('g')
            .attr('transform', 'translate(0,' + (-10) + ')')
            .attr('id', 'buttonContainer');
        initButtons(d3.select('#buttonContainer'), animation);

        controlSvg.append('g')
            .attr('transform', 'translate(0,' + (height - 165) + ')')
            .attr('id', 'dragContainer');
        initDrag(d3.select('#dragContainer'));

        d3.timer(animateBall);

        // Animate
        function animateBall() {
            if (animation.state) {
                var secondCount = (Date.now() - animation.start) / 1000;

                // x = u*t + 1/2*a*t^2
                var loc = convert(eqVars[1].active)*secondCount + (1/2)*convert(eqVars[2].active)*Math.pow(secondCount,2);
                var scaledLoc = Math.floor(eqVars[1].active/scalingFactor)*secondCount + (1/2)*Math.floor(eqVars[2].active/scalingFactor)*Math.pow(secondCount,2);

                d3.select('#ball').attr('cx', loc);

                if (d3.select('#numbersRadio').classed('active')) {
                    updateNumbers(Math.floor(secondCount), scaledLoc);
                }

                if (loc > distScale*convert(eqVars[0].active)) {
                    clickPause(animation);
                    setTimeout(function() {resetBall(animation); }, 500);
                }
            }
        }
    }

    function updateDots() {

        const dotScalingFactor = 1/6;

        var numDots = d3.select('#dots').selectAll('circle').size();

        for(var n=0; n<numDots; n++) {

            // v^2 = u^2 + 2*a*x
            var tempVel = Math.sqrt(Math.pow(convert(eqVars[1].active),2) + 2*convert(eqVars[2].active)*(distScale*convert(eqVars[0].active)*n));

            d3.select('#dotLineBody' + n)
                .transition()
                .attr('x2', tempVel * dotScalingFactor + scalingFactor);
            d3.select('#arrowHead' + n)
                .transition()
                .attr('transform', 'translate(' + (tempVel * dotScalingFactor + scalingFactor) + ',0)');
            d3.select('#topText' + n).text((Math.round(10 * tempVel / scalingFactor) / 10) + 'm/s');
            d3.select('#bottomText' + n).text(distScale*Math.floor(eqVars[0].active/scalingFactor)*n + 'm');
        }

        d3.select('#dots1')
            .transition()
            .duration(750)
            .attr('transform', 'translate(' + distScale*convert(eqVars[0].active) + ',0)');
    }

    function updateDrag(index) {
        d3.select('#' + eqVars[index].name + 'Text').text(eqVars[index].eq + (index ? 1 : distScale)*Math.floor(eqVars[index].active/scalingFactor) + eqVars[index].measure);
        d3.select('#' + eqVars[index].name + 'LineBody').attr('x2', eqVars[index].active);
        d3.select('#' + eqVars[index].name + 'DraggableContainer').attr('transform', 'translate(' + eqVars[index].active + ',0)');
    }

    // Utils
    function convert(input) {
        return Math.floor(input/scalingFactor)*scalingFactor;
    }

</script>

</body>
</html>