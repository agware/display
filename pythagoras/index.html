<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pythagorean theorem</title>

    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="../scripts/styles.css">

</head>
<body>

<div id="wrapper">
    <div id="container"></div>
</div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="../scripts/formula.js" type="text/javascript"></script>
<script src="../scripts/radioButtons.js" type="text/javascript"></script>

<script>

    const height = 350;
    const width = 500;

    const formula = ['a', '²', '+', 'b', '²', '=', 'c²'];
    const scalingFactor = 20;
    var eqVars = [{'name': 'a', 'active': 100},
                  {'name': 'b', 'active': 100}];

    var svg = d3.select('#container').append('svg')
        .attr('width', width)
        .attr('height', height)
        .attr('overflow', 'hidden');

    const textGap = [0, 30, 25, 35, 33, 27, 35];
    initFormula(svg, formula, textGap);

    svg.append('g')
        .attr('transform', 'translate(0,' + (60) + ')')
        .attr('id', 'radioContainer');
    initFormulaRadio(d3.select('#radioContainer'));

    initTriangle();

    function initTriangle() {

        initTriangleContainers();
        initArrowHead();
        initLineBody();
        initText();
        initBall();

        updateTriangle();

        function initTriangleContainers() {
            svg.append('g')
                .attr('transform', 'translate(' + 250 + ',' + (height-20) + ')')
                .attr('id', 'triangle');
            d3.select('#triangle').append('g')
                .attr('id', 'triangleRight');
            d3.select('#triangleRight').append('g')
                .attr('id', 'triangleTop');
            d3.select('#triangle').append('g')
                .attr('id', 'velocity');
            d3.select('#velocity').append('g')
                .attr('id', 'velocityArrowHead');
        }

        function initArrowHead() {
            const arrowOffset = 10;

            // horizontal line arrowHead
            d3.select('#triangleRight').selectAll('line')
                .data(d3.range(2))
                .enter().append('line')
                .attr('x2', -arrowOffset)
                .attr('y2', function(d) {return (d ? -1 : 1)*arrowOffset; })
                .classed('split', true);

            // vertical line arrowhead
            d3.select('#triangleTop').selectAll('line')
                .data(d3.range(2))
                .enter().append('line')
                .attr('x2', function(d) {return (d ? -1 : 1)*arrowOffset; })
                .attr('y2', arrowOffset)
                .classed('split', true);

            // vector arrowHead
            d3.select('#velocityArrowHead').selectAll('line')
                .data(d3.range(2))
                .enter().append('line')
                .attr('x2', -arrowOffset)
                .attr('y2', function(d) {return (d ? -1 : 1)*arrowOffset; });
        }

        function initLineBody() {
            // horizontal line
            d3.select('#triangle').append('line')
                .attr('id', 'horizontalVel')
                .classed('split', true)
                .classed('splitLine', true);
            // vertical line
            d3.select('#triangleRight').append('line')
                .attr('id', 'verticalVel')
                .classed('split', true)
                .classed('splitLine', true);
            // vector line
            d3.select('#velocity').append('line')
                .attr('id', 'vectorLineBody');
        }

        function initText() {

            const textOffset = {'horizontal': 18, 'vertical': 5, 'velocity': -5};

            d3.select('#triangle').append('text')
                .attr('y', textOffset.horizontal)
                .attr('id', 'textX');
            d3.select('#triangleRight').append('text')
                .attr('x', textOffset.vertical)
                .attr('id', 'textY');
            d3.select('#velocity').append('text')
                .attr('y', textOffset.velocity)
                .attr('id', 'textVel');

        }

        function initBall() {

            const ball = {'fixedR': 7, 'dragR': 15};

            // fixed ball
            d3.select('#triangle').append('circle')
                .attr('r', ball.fixedR);
            // draggable ball
            d3.select('#triangle').append('circle')
                .attr('r', ball.dragR)
                .attr('id', 'dragBall')
                .style('fill-opacity', 0.3)
                .style('fill', '#2c8f9c')
                .classed('clickable', true)
                .call(d3.drag()
                    .on("start", dragStart)
                    .on("drag", dragging)
                    .on("end", dragEnd));
        }
    }

    // Drags

    function dragStart() {
        d3.select(this).classed("active", true);
    }

    function dragging() {
        const lim = {'minX': 40, 'minY': 40, 'maxX': 180, 'maxY': 180};

        eqVars[0].active = Math.max(Math.min(d3.event.x, lim.maxX), lim.minX);
        eqVars[1].active = Math.max(Math.min(-d3.event.y, lim.maxY), lim.minY);

        updateTriangle();

        if (d3.select('#numbersRadio').classed('active')) {
            updateNumbers();
        }

    }

    function dragEnd() {
        d3.select(this).classed("active", false);
    }


    // Dynamic updates

    function updateTriangle() {

        const dragOffset = 4;
        const rad2deg = 180/Math.PI;
        const deg2rad = 1/rad2deg;

        var vel = Math.sqrt(Math.pow(eqVars[0].active,2) + Math.pow(eqVars[1].active,2));
        var angle = Math.atan(eqVars[1].active/eqVars[0].active)*rad2deg;

        updateContainers();
        updateLineBodies();

        d3.select('#dragBall')
            .attr('cx', eqVars[0].active - dragOffset*Math.cos(angle*deg2rad))
            .attr('cy', -eqVars[1].active + dragOffset*Math.sin(angle*deg2rad));

        updateText();

        function updateContainers() {

            d3.select('#triangleRight').attr('transform', 'translate(' + eqVars[0].active + ',0)');
            d3.select('#triangleTop').attr('transform', 'translate(0,' + (-eqVars[1].active) + ')');
            d3.select('#velocity').attr('transform', 'rotate(' + (-angle) + ')');
            d3.select('#velocityArrowHead').attr('transform', 'translate(' + vel + ',0)');

        }

        function updateLineBodies() {

            d3.select('#vectorLineBody').attr('x2', vel);
            d3.select('#horizontalVel').attr('x2', eqVars[0].active);
            d3.select('#verticalVel').attr('y2', -eqVars[1].active);

        }

        function updateText() {

            const textOffset = 5;

            var scaledX = Math.round(eqVars[0].active/scalingFactor);
            var scaledY = Math.round(eqVars[1].active/scalingFactor);
            var scaledVel = Math.round(Math.pow(Math.pow(scaledX, 2)+Math.pow(scaledY, 2), (1/2))*10)/10;

            d3.select('#textX')
                .attr('x', eqVars[0].active/2 - textOffset)
                .text(scaledX);
            d3.select('#textY')
                .attr('y', -eqVars[1].active/2 + (3/2)*textOffset)
                .text(scaledY);
            d3.select('#textVel')
                .attr('x', vel/2 - 3*textOffset)
                .text(scaledVel);
        }

    }

</script>

</body>
</html>