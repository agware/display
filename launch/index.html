<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Projectile</title>

    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="../scripts/styles.css">

</head>
<body>

<div id="wrapper">
    <div id="container"></div>
</div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="../scripts/actionButtons.js" type="text/javascript"></script>

<script>

    const width = 700;
    const height = 500;
    const ballDim = {'x': 50, 'y': 100, 'r': 20};
    const velBall = {'r': 15};
    const vectorCoords = {'x': 50, 'y': 50};
    const arrowOffset = 8;
    const colour = d3.scaleOrdinal(d3.schemeCategory10);

    var markerCount = 0;
    var animation = {'start': Date.now(), 'mem': 0, 'state': false};

    init();

    function init() {

        var svg = d3.select('#container').append('svg')
            .attr('width', width)
            .attr('height', height)
            .attr('overflow', 'hidden')
            .style('border', '1px solid black');

        initArrows();
        initBall();

        svg.append('g')
            .attr('transform', 'translate(' + (width-200) + ',0)')
            .attr('id', 'buttonContainer');
        initButtons(d3.select('#buttonContainer'), animation, true);

        d3.timer(animateBall);


        // Initialise everything
        function initBall() {

            var launchCount = 0;
            svg.append('g')
                .attr('id', 'flightPath')
                .datum(launchCount);

            svg.append('circle')
                .attr('cx', ballDim.x)
                .attr('cy', height - ballDim.y)
                .attr('r', ballDim.r)
                .attr('id', 'shadowBall')
                .style('fill-opacity', 0.3);

            svg.append('circle')
                .attr('r', ballDim.r)
                .attr('id', 'ball')
                .classed('clickable', true)
                .call(d3.drag()
                    .on("start", dragStart)
                    .on("drag", dragActiveBall)
                    .on("end", dragEnd))
                .on("mouseover", mouseOver)
                .on("mouseout", mouseOut);

            resetBall(animation);
        }

        function initArrows() {

            initHeightArrow();
            initTriangle();

            function initHeightArrow() {
                svg.append('g')
                    .attr('transform', 'translate(' + ballDim.x + ',' + height + ')')
                    .attr('id', 'heightArrowContainer');

                d3.select('#heightArrowContainer').append('line')
                    .attr('id', 'heightLineBody');

                initArrowHeads();

                updateHeightArrow();

                function initArrowHeads() {
                    d3.select('#heightArrowContainer').append('g')
                        .attr('id', 'heightArrowHeadContainer');

                    d3.select('#heightArrowHeadContainer').selectAll('line')
                        .data(d3.range(2))
                        .enter().append('line')
                        .attr('x2', function(d) {return (d ? -1 : 1) * arrowOffset; })
                        .attr('y2', -arrowOffset);

                    d3.select('#heightArrowContainer').append('g')
                        .attr('id', 'heightTopArrowHeadContainer');

                    d3.select('#heightTopArrowHeadContainer').selectAll('line')
                        .data(d3.range(2))
                        .enter().append('line')
                        .attr('x2', function(d) {return (d ? -1 : 1) * arrowOffset; })
                        .attr('y2', arrowOffset);
                }
            }

            function initTriangle() {

                initTriangleContainers();
                initArrowHead();
                initLineBody();
                initBall();

                updateTriangle();

                function initTriangleContainers() {
                    svg.append('g')
                        .attr('transform', 'translate(' + ballDim.x + ',' + (height-ballDim.y) + ')')
                        .attr('id', 'triangle');
                    d3.select('#triangle').append('g')
                        .attr('id', 'triangleRight');
                    d3.select('#triangleRight').append('g')
                        .attr('id', 'triangleTop');
                    d3.select('#triangle').append('g')
                        .attr('id', 'velocity');
                    d3.select('#velocity').append('g')
                        .attr('id', 'velocityArrowHead');
                }

                function initArrowHead() {
                    // horizontal line arrowHead
                    d3.select('#triangleRight').selectAll('line')
                        .data(d3.range(2))
                        .enter().append('line')
                        .attr('x2', -arrowOffset)
                        .attr('y2', function(d) {return (d ? -1 : 1)*arrowOffset; })
                        .classed('split', true);

                    // vertical line arrowhead
                    d3.select('#triangleTop').selectAll('line')
                        .data(d3.range(2))
                        .enter().append('line')
                        .attr('x2', function(d) {return (d ? -1 : 1)*arrowOffset; })
                        .attr('y2', arrowOffset)
                        .classed('split', true);

                    // vector arrowHead
                    d3.select('#velocityArrowHead').selectAll('line')
                        .data(d3.range(2))
                        .enter().append('line')
                        .attr('x2', -arrowOffset)
                        .attr('y2', function(d) {return (d ? -1 : 1)*arrowOffset; });
                }

                function initLineBody() {
                    // horizontal line
                    d3.select('#triangle').append('line')
                        .attr('id', 'horizontalVel')
                        .classed('split', true)
                        .classed('splitLine', true);
                    // vertical line
                    d3.select('#triangleRight').append('line')
                        .attr('id', 'verticalVel')
                        .classed('split', true)
                        .classed('splitLine', true);
                    // vector line
                    d3.select('#velocity').append('line')
                        .attr('id', 'vectorLineBody');
                }

                function initBall() {

                    // draggable ball
                    d3.select('#triangle').append('circle')
                        .attr('r', velBall.r)
                        .attr('id', 'velBall')
                        .style('fill-opacity', 0.3)
                        .style('fill', '#2c8f9c')
                        .classed('clickable', true)
                        .call(d3.drag()
                            .on("start", dragStart)
                            .on("drag", dragVelBall)
                            .on("end", dragEnd));
                }

            }

        }


        // Animation
        function animateBall() {
            if (animation.state) {
                const g = -9.81;

                var t = (Date.now() - animation.start)/100;

                while (markerCount <= t) {
                    var tempX = vectorCoords.x*markerCount + ballDim.x;
                    var tempY = vectorCoords.y*markerCount + (1/2)*(g)*Math.pow(markerCount, 2) + ballDim.y;

                    var launchCount = d3.select('#flightPath').datum();

                    d3.select('#flightPath').append('circle')
                        .attr('r', 2)
                        .attr('cx', tempX)
                        .attr('cy', height - tempY)
                        .style('fill', colour(launchCount % 10));

                    markerCount += 0.2;
                }

                // x = ut + (1/2)at^2 + (starting position)
                var dimX = vectorCoords.x*t + ballDim.x;
                var dimY = vectorCoords.y*t + (1/2)*(g)*Math.pow(t, 2) + ballDim.y;

                d3.select('#ball')
                    .attr('cx', dimX)
                    .attr('cy', height - dimY);

                if (tempX > (width + 2*ballDim.r) || tempY < -2*ballDim.r) {
                    clickPause(animation);
                    resetBall(animation);
                }
            }
        }
    }

    // On drag
    function dragStart() {
        d3.select(this).classed("active", true);
    }

    function dragActiveBall() {
        if (!animation.state) {
            const lim = {'minY': ballDim.r, 'maxY': height-ballDim.r};

            ballDim.y = height - Math.max(Math.min(d3.event.y, lim.maxY), lim.minY);

            d3.select('#shadowBall')
                .attr('cy', height - ballDim.y);

            d3.select('#ball')
                .attr('cy', height - ballDim.y);

            updateHeightArrow();

            d3.select('#triangle').attr('transform', 'translate(' + ballDim.x + ',' + (height-ballDim.y) + ')');
            if (ballDim.y + vectorCoords.y > (height-velBall.r)) {
                vectorCoords.y = height - ballDim.y - velBall.r;
                updateTriangle();
            }
        }
    }

    function dragVelBall() {
        if (!animation.state) {
            var lim = {'minX': 0, 'minY': 0, 'maxX': width - ballDim.x - velBall.r, 'maxY': height - ballDim.y - velBall.r};

            var tempX = Math.max(Math.min(d3.event.x, lim.maxX), lim.minX);
            var tempY = Math.max(Math.min(-d3.event.y, lim.maxY), lim.minY);
            var tempR = Math.sqrt(Math.pow(tempX,2) + Math.pow(tempY,2));

            if ((tempR - velBall.r) >= ballDim.r) {
                vectorCoords.x = Math.max(Math.min(d3.event.x, lim.maxX), lim.minX);
                vectorCoords.y = Math.max(Math.min(-d3.event.y, lim.maxY), lim.minY);
            }

            updateTriangle();
        }
    }

    function dragEnd() {
        d3.select(this).classed("active", false);
    }


    // On mouse over
    function mouseOver() {
        d3.select(this).classed('hover', true);
    }

    function mouseOut() {
        d3.select(this).classed('hover', false);
    }


    // Updates and resets
    function resetBall(animation) {
        d3.select('#ball')
            .style('fill-opacity', 0)
            .attr('cx', ballDim.x)
            .attr('cy', height - ballDim.y)
            .transition()
            .duration(500)
            .style('fill-opacity', 1);

        animation.mem = 0;
        markerCount = 0;
    }

    function updateTriangle() {

        const dragOffset = 4;
        const rad2deg = 180/Math.PI;
        const deg2rad = 1/rad2deg;

        var vel = Math.sqrt(Math.pow(vectorCoords.x,2) + Math.pow(vectorCoords.y,2));
        var angle = Math.atan(vectorCoords.y/vectorCoords.x)*rad2deg;

        updateContainers();
        updateLineBodies();

        d3.select('#velBall')
            .attr('cx', vectorCoords.x - dragOffset*Math.cos(angle*deg2rad))
            .attr('cy', -vectorCoords.y + dragOffset*Math.sin(angle*deg2rad));

        function updateContainers() {

            d3.select('#triangleRight').attr('transform', 'translate(' + vectorCoords.x + ',0)');
            d3.select('#triangleTop').attr('transform', 'translate(0,' + (-vectorCoords.y) + ')');
            d3.select('#velocity').attr('transform', 'rotate(' + (-angle) + ')');
            d3.select('#velocityArrowHead').attr('transform', 'translate(' + vel + ',0)');

        }

        function updateLineBodies() {

            d3.select('#vectorLineBody').attr('x2', vel);
            d3.select('#horizontalVel').attr('x2', vectorCoords.x);
            d3.select('#verticalVel').attr('y2', -vectorCoords.y);

        }

    }

    function updateHeightArrow() {
        var arrowHeight = ballDim.y - ballDim.r;

        d3.select('#heightLineBody').attr('y2', -arrowHeight);

        d3.select('#heightArrowHeadContainer')
            .style('stroke-opacity', (arrowHeight <= 2*arrowOffset ? 0 : 1));

        d3.select('#heightTopArrowHeadContainer')
            .attr('transform', 'translate(0,' + (-arrowHeight) + ')')
            .style('stroke-opacity', (arrowHeight <= arrowOffset ? 0 : 1));
    }


</script>

</body>
</html>